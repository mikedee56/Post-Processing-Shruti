# Story 2.4.2: Semantic Similarity Calculator Implementation

## Status
Draft

## Story
**As a** Yoga Vedanta transcript processor,  
**I want** semantic similarity computation using iNLTK embeddings with caching capabilities,  
**so that** the system can perform accurate Stage 3 semantic matching in the hybrid pipeline and enhance contextual analysis across Stories 2.2 and 2.3.

## Acceptance Criteria

1. The system can compute semantic similarity between Sanskrit/Hindi text pairs using iNLTK sentence embeddings
2. The system can cache pre-computed semantic embeddings to file-based storage for performance optimization  
3. The system can perform batch semantic similarity calculations for multiple text pairs efficiently
4. The semantic similarity scores are normalized to 0.0-1.0 range and consistent with existing confidence scoring
5. The system gracefully handles Sanskrit, Hindi, and English text inputs with appropriate model selection
6. The system integrates with existing Story 2.2 contextual modeling for enhanced validation
7. The system provides semantic embeddings for Story 2.3 scripture database enhancement
8. All existing Story 2.2 and Story 2.3 functionality continues to work unchanged

## Tasks / Subtasks

- [ ] Implement SemanticSimilarityCalculator core component (AC: 1,4,5)
  - [ ] Add iNLTK dependency and model loading
  - [ ] Implement compute_semantic_similarity() method with normalized scoring
  - [ ] Add language detection and appropriate model selection
  - [ ] Handle error cases with graceful fallback

- [ ] Implement semantic embedding caching system (AC: 2,7)  
  - [ ] Create SemanticVectorCache data model from architecture
  - [ ] Implement file-based embedding storage using JSON format
  - [ ] Add cache invalidation and version tracking
  - [ ] Create batch embedding computation for scripture database

- [ ] Implement batch processing capabilities (AC: 3)
  - [ ] Add batch_compute_similarities() method for multiple pairs
  - [ ] Optimize for file-based architecture with minimal memory usage
  - [ ] Add progress tracking for large batch operations

- [ ] Integrate with Story 2.2 contextual modeling (AC: 6,8)
  - [ ] Enhance contextual rules with semantic validation
  - [ ] Add semantic context validation to existing n-gram models
  - [ ] Ensure backward compatibility with existing Story 2.2 functionality

- [ ] Integrate with Story 2.3 scripture processing (AC: 7,8)  
  - [ ] Enhance scripture YAML schema with semantic_embedding fields
  - [ ] Create migration script for existing scripture files
  - [ ] Add semantic similarity to verse candidate selection

- [ ] Testing and validation (All AC)
  - [ ] Unit tests for core semantic similarity computation
  - [ ] Integration tests with Stories 2.2 and 2.3
  - [ ] Performance tests for batch operations and caching
  - [ ] Regression tests to ensure existing functionality unchanged

## Dev Notes

### Architecture Integration Points
Based on `docs/scripture-enhancement-architecture.md`:

**Component Location**: `src/contextual_modeling/semantic_similarity_calculator.py` (lines 245-246)
**Integration Strategy**: Layer enhancement pattern - extend existing Story 2.2 and Story 2.3 components without replacing core functionality
**Dependencies**: Add iNLTK, numpy, scipy to requirements.txt as specified in architecture (lines 74-80)

**Key Integration Points:**
- **Story 2.2 Enhancement**: Enhance `src/contextual_modeling/` components with semantic validation (lines 192-200) 
- **Story 2.3 Enhancement**: Extend `src/scripture_processing/canonical_text_manager.py` with semantic vectors (lines 238-239)
- **File-Based Architecture**: Use enhanced YAML schema from architecture lines 129-152

**Data Models**: 
- Implement `SemanticVectorCache` from architecture lines 99-109
- Support enhanced scripture YAML schema with semantic_embedding fields (lines 136-142)

**Cross-Story Enhancement**: This component provides semantic capabilities for both Story 2.2 contextual validation and Story 2.3 verse matching as specified in lines 172-200

### Testing
- **Test Location**: `tests/test_semantic_similarity_calculator.py`
- **Framework**: pytest with enhanced fixtures for Sanskrit linguistic test data (lines 330-333)
- **Coverage Target**: 90%+ for new research algorithm implementations
- **Integration Tests**: Validate existing Story 2.2 and Story 2.3 functionality continues working with enhancements enabled/disabled
- **Performance Benchmarks**: Compare against basic implementations, validate <2x processing time increase (line 55)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-07 | 1.0 | Initial story creation based on architecture document | Sarah (Product Owner) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be recorded by dev agent*

### Debug Log References
*To be recorded by dev agent*

### Completion Notes List
*To be recorded by dev agent*

### File List
*To be recorded by dev agent*

## QA Results
*Results from QA Agent review will be recorded here*