# Story 2.4.1: Sanskrit Sandhi Preprocessing Foundation

## Status
Ready for Development

## Story
**As a** Sanskrit post-processing system,  
**I want** to properly split Sanskrit compound words (sandhi) before lexicon matching,  
**So that** individual word components can be correctly identified and processed by existing Story 2.1 fuzzy matching.

## Acceptance Criteria

### Functional Requirements
1. **Sandhi Splitting:** Process Sanskrit text like "yogaścittavṛttinirodhaḥ" → ["yogaḥ", "citta", "vṛtti", "nirodhaḥ"]
2. **Multiple Candidates:** Return alternative segmentations with confidence scores when ambiguous
3. **Integration:** Seamlessly integrate as preprocessing step in existing `SanskritHindiIdentifier.identify_words()`

### Integration Requirements  
4. **Existing Story 2.1** lexicon-based correction continues working unchanged
5. **Preprocessing Pattern** follows existing `TextNormalizer` → `SanskritHindiIdentifier` pattern
6. **Graceful Fallback** system works with basic tokenization if `sanskrit_parser` fails

### Quality Requirements
7. **Test Coverage** comprehensive tests for sandhi splitting accuracy
8. **Documentation** component integration documented for future enhancements  
9. **Regression Protection** all existing Story 2.1 functionality verified unchanged

## Tasks / Subtasks
- [ ] Task 1: Implement SandhiPreprocessor Component (AC: 1, 2)
  - [ ] Install and integrate `sanskrit_parser` library dependency
  - [ ] Create `SandhiPreprocessor` class with sandhi splitting functionality
  - [ ] Implement multiple candidate segmentation with confidence scoring
  - [ ] Add error handling and graceful fallback to basic tokenization
- [ ] Task 2: Integrate with Existing SanskritHindiIdentifier (AC: 3, 4, 5)
  - [ ] Modify `SanskritHindiIdentifier.identify_words()` to use sandhi preprocessing
  - [ ] Maintain backward compatibility with existing Story 2.1 API
  - [ ] Follow existing preprocessing pattern used by `TextNormalizer`
  - [ ] Add feature flag for enabling/disabling sandhi preprocessing
- [ ] Task 3: Testing and Validation (AC: 6, 7, 8, 9)
  - [ ] Create comprehensive test suite for sandhi splitting accuracy
  - [ ] Test edge cases and malformed Sanskrit input handling
  - [ ] Verify all existing Story 2.1 tests continue passing
  - [ ] Add performance benchmarks for processing time impact
- [ ] Task 4: Documentation and Integration Preparation (AC: 8, 9)
  - [ ] Document SandhiPreprocessor component for future Story 2.4 integration
  - [ ] Update existing component documentation with sandhi preprocessing
  - [ ] Create migration guide for enabling sandhi preprocessing feature

## Story Context

### Existing System Integration
- **Integrates with:** `SanskritHindiIdentifier.identify_words()` in Story 2.1
- **Technology:** Python 3.10, existing `sanskrit_post_processor.py` pipeline  
- **Follows pattern:** Preprocessing layer pattern used by existing `TextNormalizer`
- **Touch points:** Input to existing word identification, output to fuzzy matching pipeline

### Technical Notes
- **Integration Approach:** New `SandhiPreprocessor` component called before existing word identification
- **Key Dependency:** `sanskrit_parser` library for sandhi analysis
- **Existing Pattern Reference:** Follow `TextNormalizer` preprocessing pattern in current pipeline
- **Key Constraints:** Must maintain backward compatibility with existing Story 2.1 API

### Definition of Done
- [ ] `SandhiPreprocessor` component implemented with `sanskrit_parser` integration
- [ ] Existing `SanskritHindiIdentifier` enhanced to use sandhi preprocessing
- [ ] Comprehensive tests for sandhi splitting accuracy and edge cases  
- [ ] All existing Story 2.1 tests pass unchanged
- [ ] Performance benchmarks show acceptable processing time impact (<2x processing time)
- [ ] Component documented for Story 2.4 hybrid matching integration
- [ ] Feature flag implemented for controlled rollout

## Dev Notes

### Previous Story Dependencies
- **Story 2.1:** Lexicon-based correction with `SanskritHindiIdentifier` and `FuzzyMatcher`
- **Existing Pattern:** `TextNormalizer` preprocessing pattern for text enhancement
- **Integration Point:** Enhance existing word identification without breaking current functionality

### Data Models
- **New:** `SandhiSplitResult` data class for capturing sandhi analysis results
- **Enhanced:** `SanskritHindiIdentifier` to accept preprocessed text input
- **Maintains:** All existing Story 2.1 interfaces and data structures

### API Specifications  
- **New Component:** `SandhiPreprocessor` with sandhi splitting methods
- **Enhanced Component:** `SanskritHindiIdentifier.identify_words()` with optional sandhi preprocessing
- **Feature Flag:** `enable_sandhi_preprocessing` configuration parameter

### Component Specifications
- **SandhiPreprocessor:** Core sandhi splitting using `sanskrit_parser` library
- **Enhanced SanskritHindiIdentifier:** Integration point for sandhi preprocessing
- **Configuration:** Feature flags for controlled rollout and performance monitoring

### File Locations
- `src/sanskrit_hindi_identifier/sandhi_preprocessor.py` - New sandhi preprocessing component
- `src/sanskrit_hindi_identifier/word_identifier.py` - Enhanced with sandhi integration
- `src/utils/` - Potential utility classes for sandhi result processing
- `tests/test_sandhi_preprocessing.py` - Comprehensive test suite
- `config/` - Configuration for sandhi preprocessing features

### Testing Requirements
- Unit tests for `SandhiPreprocessor` sandhi splitting accuracy with known Sanskrit text pairs
- Integration tests verifying enhanced `SanskritHindiIdentifier` works with sandhi preprocessing
- Regression tests ensuring all existing Story 2.1 functionality remains unchanged
- Performance tests measuring processing time impact of sandhi preprocessing
- Edge case tests for malformed input and fallback behavior

### Technical Constraints
- **Dependency Management:** Add `sanskrit_parser` to requirements.txt with version pinning
- **Performance:** Sandhi preprocessing should not exceed 2x processing time increase
- **Compatibility:** Maintain full backward compatibility with existing Story 2.1 API
- **Error Handling:** Graceful fallback when `sanskrit_parser` fails or is unavailable
- **Feature Flags:** Controllable rollout and monitoring capabilities

## Testing
- **Test file location:** `tests/test_sandhi_preprocessing.py`
- **Test standards:** Unit tests for sandhi splitting accuracy, integration tests for Story 2.1 enhancement
- **Testing frameworks:** pytest with existing fixture patterns
- **Specific testing requirements:**
  - Test sandhi splitting accuracy with manually verified Sanskrit text cases
  - Test multiple segmentation candidates and confidence scoring
  - Test integration with existing `SanskritHindiIdentifier` processing pipeline
  - Test graceful fallback when sandhi preprocessing fails
  - Regression test all existing Story 2.1 functionality remains unchanged
  - Performance test processing time impact within acceptable limits

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 7, 2025 | 1.0 | Initial story creation for Sanskrit sandhi preprocessing foundation | John, PM |

## Dev Agent Record
Ready for development - no implementation started

## QA Results
[To be populated by QA agent after implementation]