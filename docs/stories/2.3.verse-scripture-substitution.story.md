# Story 2.3: Verse and Scripture Substitution

## Status
Draft

## Story
**As a** post-processing script,
**I want** to identify and replace scriptural verses with the canonical text,
**so that** the transcript is academically sound and authoritative.

## Acceptance Criteria
1. The system can identify longer Sanskrit/Hindi passages that correspond to known scriptural verses in the lexicon.
2. The system can replace the transcribed passage with the canonical text for that verse.
3. The verse and scripture identification is based on a standardized presentation (e.g., IAST) from the lexicon.
4. The system can provide a list of potential canonical verses for selection from standardized sources in the lexicon.

## Tasks / Subtasks
- [ ] Task 1: Implement Scripture Passage Identification (AC: 1)
  - [ ] Create verse detection algorithm for longer Sanskrit/Hindi passages
  - [ ] Build passage segmentation logic for multi-line verses
  - [ ] Implement similarity scoring for partial verse matches
  - [ ] Add confidence thresholds for verse identification
- [ ] Task 2: Canonical Text Substitution System (AC: 2)
  - [ ] Create verse replacement engine with canonical text lookup
  - [ ] Implement passage boundary detection for accurate substitution
  - [ ] Build validation system to ensure substitution accuracy
  - [ ] Add rollback capability for incorrect substitutions
- [ ] Task 3: IAST Standardization for Scripture (AC: 3)
  - [ ] Extend IAST transliterator for complete verse handling
  - [ ] Implement verse-specific IAST formatting rules
  - [ ] Create consistency validation across scriptural passages
  - [ ] Add support for verse metadata (source, chapter, verse number)
- [ ] Task 4: Canonical Verse Selection System (AC: 4)
  - [ ] Build verse candidate ranking system
  - [ ] Create interactive selection interface for ambiguous cases
  - [ ] Implement confidence-based automatic selection
  - [ ] Add verse source attribution and referencing

## Dev Notes

### Previous Story Insights
- Story 2.1 established robust lexicon-based correction with comprehensive fuzzy matching
- Story 2.2 added contextual modeling with n-gram language models and phonetic representations
- Enhanced SanskritPostProcessor now supports contextual analysis and statistical modeling
- Existing LexiconEntry model includes is_verse flag and canonical_text field for verses
- IAST transliteration system is mature and ready for verse-level application

### Data Models
Based on PRD data models and previous story implementations:
- **LexiconEntry**: Enhanced with canonical_text, is_verse fields for scripture handling [Source: docs/prd/8-data-models.md#LexiconEntry]
- **TranscriptSegment**: Contains processing_metadata for verse identification tracking [Source: docs/prd/8-data-models.md#TranscriptSegment]
- **New for Story 2.3**: VerseMatch, ScripturalPassage, CanonicalReference data structures needed
- **ProcessingResult**: Extended to track verse_substitutions, canonical_accuracy metrics

### API Specifications
Building on Stories 2.1 and 2.2 architecture:
- **Verse Detection**: Integration with contextual modeling for passage-level analysis
- **Canonical Lookup**: Extension of existing lexicon management for verse databases
- **IAST Processing**: Enhancement of existing transliteration for complete verses
- **Selection Interface**: New component for handling ambiguous verse identification

### Component Specifications
Building on Epic 2 foundation:
- **ScriptureIdentifier**: Core module for identifying verses and longer passages
- **CanonicalTextManager**: System for managing and retrieving canonical verse texts
- **VerseSubstitutionEngine**: Engine for replacing transcribed passages with canonical text
- **ScriptureValidator**: Validation system for verse identification accuracy
- **Enhanced LexiconManager**: Extended to handle scriptural databases and verse metadata
- **Enhanced SanskritPostProcessor**: Integration of all verse substitution capabilities

### File Locations
Based on existing project structure from Stories 2.1 and 2.2:
- `src/scripture_processing/` - New scripture handling modules
  - `scripture_identifier.py` - Verse and passage identification
  - `canonical_text_manager.py` - Canonical text management and lookup
  - `verse_substitution_engine.py` - Verse replacement processing
  - `scripture_validator.py` - Validation and quality assurance
- `src/sanskrit_hindi_identifier/` - Enhanced modules
  - `lexicon_manager.py` - Extended for scriptural database handling
- `src/post_processors/` - Enhanced post-processing
  - `sanskrit_post_processor.py` - Integrate scripture substitution capabilities
- `data/scriptures/` - Canonical scripture databases
  - `bhagavad_gita.yaml` - Bhagavad Gita canonical verses
  - `upanishads.yaml` - Upanishads canonical texts
  - `yoga_sutras.yaml` - Patanjali's Yoga Sutras
- `config/scripture_config.yaml` - Configuration for verse identification and substitution
- `tests/test_scripture_processing.py` - Test suite for scripture processing features

### Testing Requirements
Based on Epic 2 testing patterns and academic rigor requirements:
- Unit tests for verse identification accuracy with known passages
- Integration tests for canonical text substitution with various scripture sources
- Validation tests for IAST compliance in substituted verses
- Performance tests for scripture processing with large document volumes
- End-to-end tests with complex scriptural quotation scenarios
- Golden dataset validation for verse substitution accuracy and academic compliance

### Technical Constraints
Based on PRD technical architecture and academic requirements:
- Python 3.10+ runtime environment with enhanced text processing capabilities
- Integration with existing Epic 2 contextual modeling and lexicon systems
- Maintain timestamp integrity during verse substitution operations
- Support for multiple scriptural sources (Bhagavad Gita, Upanishads, Yoga Sutras, etc.)
- Academic rigor standards for canonical text accuracy and IAST compliance
- Performance requirements for real-time verse identification in large corpora

### Project Structure Notes
This story completes Epic 2 by building on the comprehensive foundation:
- Leverages Story 2.1's lexicon-based correction and fuzzy matching capabilities
- Uses Story 2.2's contextual modeling for better verse boundary detection
- Extends existing IAST transliteration system for complete verse handling
- Integrates with established configuration and processing pipeline infrastructure
- Adds final layer of academic rigor with canonical text substitution

## Testing
- **Test file location**: `tests/test_scripture_processing.py`
- **Test standards**: Unit tests for each component, integration tests for verse substitution pipeline
- **Testing frameworks**: pytest for Python testing, with coverage reporting and academic accuracy validation
- **Specific testing requirements**: 
  - Test verse identification accuracy with partial and complete passages
  - Test canonical text substitution with various scriptural sources
  - Test IAST compliance and formatting for substituted verses
  - Test verse selection system with ambiguous passage scenarios
  - Test integration with existing Epic 2 correction and contextual systems
  - Validate academic accuracy and source attribution for all substitutions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| August 6, 2025 | 1.0 | Initial story creation | Bob, SM |

## Dev Agent Record

### Agent Model Used
[To be populated by dev agent]

### Debug Log References  
[To be populated by dev agent]

### Completion Notes List
[To be populated by dev agent]

### File List
[To be populated by dev agent]

## QA Results
[To be populated by QA agent]